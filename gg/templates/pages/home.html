{% extends "base.html" %}

{% block content %}
	<div class="container">
        <div id="app" class="m-b-1" style="margin-top: 50px">
          <form id="assignmentForm" v-if="showForm">
            <div class="form-group">
              <input type="text" class="form-control" v-model="q" @input="typeInput">
              <search-item 
                v-for="item in search" 
                :item="item" 
                :key="item.id"
                v-on:click="changeStateItem">  
               </search-item>
            </div>
            <div class="form-group row">
              <p class="form-control-static">Выбранные услуги: #{ checkedItems }</p>
            </div>
            <div class="form-group row">
              <p class="form-control-static">Количество услуг: #{ checkedItems.length }</p>
            </div>
            <button class="btn btn-outline-secondary my-2" v-if="checkedItems.length" @click.prevent="checkUser">Submit</button>
          </form>

        <!--button id="show-modal" @click="showModal = true">Show Modal</button-->
        <!-- use the modal component, pass in the prop -->
        <modal v-if="showModal" @close="showModal = false">
          <!--
            you can use custom content here to overwrite
            default content
          -->
          <h3 slot="header">custom header</h3>
        </modal>

        </div>





	</div>

{% endblock content %}

{% block  included_javascript %}
      <script type="text/javascript">
        
      Vue.component('modal', {
        template: '#modal-template',
        data: function() {
          return {
            loginState: false,
          }
        }
      })

      Vue.component('search-item', {
        props: ['item', 'value'],
        delimiters: ["#{", "}"],
        template: '#search-item',
        data: function() {
          return {
            inStock: false
          }
        },
        methods: {
          clickedItem: function() {
            this.$emit('click', this.item, this.inStock)
          },
        }
      })

Vue.http.headers.common['X-CSRF-TOKEN'] = csrftoken
      var app = new Vue({
        el: '#app',
        delimiters: ["#{", "}"],
        data: {
          searchendpoint: 'http://' + window.location.host + '/search/autocomplete/?q=',
          submitendpoint: 'http://' + window.location.host + '/crm/~create/',
          q: '',
          search: [],
          checkedItems: [],
          showModal: false,
          showForm: true,
        },
        methods: {
          typeInput: function() {
            this.$http.post(this.searchendpoint + this.q).then(
               function(response){
                this.search = response.data
            }, function(error){
              //console.log(error)
            })
          },
          changeStateItem: function(item, inStock) {
            if (inStock) {
              this.checkedItems.push(item.title)
            } else {
              this.checkedItems.pop(item.title)
            }
          },
          submitForm: function() {
            this.$http.post(this.submitendpoint, this.checkedItems).then(
               function(response){
                alert(response.data)
            }, function(error){
                alert(this.$http.headers.common['X-CSRF-TOKEN'])
                //alert(error.data)
            })
          },
          checkUser: function() {
            if ('{{ user }}' == 'AnonymousUser') {
              this.showModal = true
            } else {
              this.submitForm()
              this.showForm = false
            }
          }
        },
      })

      </script>

<script type="text/x-template" id="modal-template">
  <transition name="modal">
    <div class="modal-mask">
      <div class="modal-wrapper">
        <div class="modal-container">

          <div class="modal-header">
            <slot name="header">
              default header
            </slot>
          </div>

          <div class="modal-body">
            <slot name="body">
              <template v-if="this.loginState === true">
              {% include 'account/modal-login.html' %}
              </template>
              <template v-else>
              {% include 'account/modal-signup.html' %}
              </template>
            
            <div class="btn-group" data-toggle="buttons">
              <button class="btn btn-primary" @click="loginState = false" v-if="loginState === true">
                Signup
              </button>
              <button class="btn btn-primary" @click="loginState = true" v-else>
                Login
              </button>
            </div>
            </slot>

          </div>

          <div class="modal-footer">
            <slot name="footer">
              default footer
              <button class="modal-default-button" @click="$emit('close')">
                CLOSE
              </button>
            </slot>
          </div>
        </div>
      </div>
    </div>
  </transition>
</script>

  <script type="text/x-template" id="search-item">
    <div class="form-group row" @click="clickedItem">
      <p class="form-control-static" @click="inStock =! inStock">
        <i v-show="inStock" class="fa fa-check"></i>Название #{ item.title }
      </p>
    </div>
  </script>

{% endblock included_javascript %}